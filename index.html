<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SalusMotion_BLE</title>

<style>
body{font-family:system-ui;margin:20px;background:#f5f5f5}
h2{margin-bottom:15px}
.card{background:#fff;padding:16px;border-radius:14px;margin-bottom:16px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
button{padding:10px 14px;border-radius:10px;border:0;background:#111;color:#fff;font-weight:600}
button.secondary{background:#fff;color:#111;border:1px solid #111}
button:disabled{opacity:.4}
select{padding:8px;border-radius:8px}
.grid{display:grid;grid-template-columns:120px 1fr;gap:8px 10px}
.progress{height:10px;background:#eee;border-radius:20px;overflow:hidden}
.bar{height:100%;width:0;background:#111;transition:.3s}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;background:#eee}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{padding:6px;border-bottom:1px solid #eee;text-align:left}
</style>
</head>
<body>

<h2>SalusMotion_BLE</h2>

<div class="card">
  <button id="btnConnect">Connect</button>
  <button id="btnSync" disabled>Sync Sets</button>
</div>

<div class="card">
  <b>Esercizio</b><br><br>
  <select id="exerciseSelect"></select>
  <button class="secondary" id="btnSetEx" disabled>Set Exercise</button>
</div>

<div class="card">
  <b>Batteria</b>
  <div class="progress" style="margin-top:10px"><div id="batBar" class="bar"></div></div>
  <div class="grid" style="margin-top:10px">
    <div>Percentuale</div><div id="batPct">-</div>
    <div>Tensione</div><div id="batVolt">-</div>
    <div>Stato</div><div id="batState">-</div>
  </div>
</div>

<div class="card">
  <b>Set sincronizzati</b>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Exercise</th>
        <th>Reps</th>
        <th>Quality</th>
        <th>VelLoss</th>
        <th>RomLoss</th>
        <th>Dirty</th>
      </tr>
    </thead>
    <tbody id="setsTable"></tbody>
  </table>
</div>

<script>
const UUID_SERVICE="b5f90001-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_TX="b5f90002-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_RX="b5f90003-6c3f-4c6b-a5d6-3adfe0c0b6a1";

let dev,server,svc,chTX,chRX;
let rxBuf="";
let exercises=[];
let sets=[];

async function writeCmd(obj){
  const enc=new TextEncoder();
  await chRX.writeValue(enc.encode(JSON.stringify(obj)));
}

function updateBattery(b){
  if(!b)return;
  const pct=Number(b.pct||0);
  const v=Number(b.v||0);
  const chg=b.chg===true;

  document.getElementById("batPct").textContent=pct+"%";
  document.getElementById("batVolt").textContent=v.toFixed(2)+" V";
  document.getElementById("batState").textContent=chg?"âš¡ Charging":"Battery mode";
  document.getElementById("batBar").style.width=pct+"%";
}

function renderSets(){
  const tbody=document.getElementById("setsTable");
  tbody.innerHTML="";
  sets.sort((a,b)=>a.id-b.id);
  sets.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${s.id}</td>
      <td>${s.exercise}</td>
      <td>${s.reps}</td>
      <td>${Number(s.quality).toFixed(1)}</td>
      <td>${Number(s.velLoss).toFixed(1)}%</td>
      <td>${Number(s.romLoss).toFixed(1)}%</td>
      <td>${Number(s.dirty).toFixed(1)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function handleJsonLine(line){
  if(!line.trim())return;
  const obj=JSON.parse(line);

  if(obj.type==="hello"||obj.type==="meta"){
    updateBattery(obj.bat);
    if(obj.exercises){
      exercises=obj.exercises;
      const sel=document.getElementById("exerciseSelect");
      sel.innerHTML="";
      exercises.forEach((ex,i)=>{
        const opt=document.createElement("option");
        opt.value=i;
        opt.textContent=ex;
        sel.appendChild(opt);
      });
      sel.value=obj.exIndex||0;
    }
    return;
  }

  if(typeof obj.id==="number" && obj.exercise){
    sets.push(obj);
    renderSets();
    return;
  }
}

function onNotify(e){
  const dec=new TextDecoder();
  rxBuf+=dec.decode(e.target.value);
  let idx;
  while((idx=rxBuf.indexOf("\n"))>=0){
    const line=rxBuf.slice(0,idx);
    rxBuf=rxBuf.slice(idx+1);
    handleJsonLine(line);
  }
}

document.getElementById("btnConnect").onclick=async()=>{
  dev=await navigator.bluetooth.requestDevice({
    filters:[{services:[UUID_SERVICE]}],
    optionalServices:[UUID_SERVICE]
  });
  server=await dev.gatt.connect();
  svc=await server.getPrimaryService(UUID_SERVICE);
  chTX=await svc.getCharacteristic(UUID_TX);
  chRX=await svc.getCharacteristic(UUID_RX);
  await chTX.startNotifications();
  chTX.addEventListener("characteristicvaluechanged",onNotify);

  document.getElementById("btnSync").disabled=false;
  document.getElementById("btnSetEx").disabled=false;

  await writeCmd({cmd:"HELLO"});
  await writeCmd({cmd:"META"});
};

document.getElementById("btnSync").onclick=async()=>{
  sets=[];
  renderSets();
  await writeCmd({cmd:"GET_SETS",from:0});
};

document.getElementById("btnSetEx").onclick=async()=>{
  const i=parseInt(document.getElementById("exerciseSelect").value,10);
  await writeCmd({cmd:"SET_EX",i});
};
</script>

</body>
</html>
