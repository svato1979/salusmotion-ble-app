<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SalusMotion_BLE</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#6b7280;--line:#e5e7eb;}
    body{font-family:system-ui,Arial;margin:16px;background:var(--bg);color:var(--text)}
    h2{margin:0 0 10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
    button{padding:10px 12px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:800}
    button.secondary{background:#fff;color:#111;border:1px solid #111}
    button.danger{background:#fff;color:#dc2626;border:1px solid #dc2626}
    button:disabled{opacity:.45}
    select,input{padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;background:#eee}
    .badge.ok{background:#e8f8ee;color:#16a34a}
    .badge.warn{background:#fff7e6;color:#f59e0b}
    .badge.bad{background:#ffe9e9;color:#dc2626}
    .grid{display:grid;grid-template-columns:140px 1fr;gap:8px 10px;font-size:14px;margin-top:10px}
    .progress{height:12px;background:#eee;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0%;background:#111;transition:width .2s ease}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.04em}
    .right{text-align:right}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;white-space:pre-wrap}
    .hidden{display:none}
    .pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px;font-weight:800}
  </style>
</head>

<body>
<h2>SalusMotion_BLE</h2>

<div class="card">
  <div class="row">
    <button id="btnConnect">Connect</button>
    <button class="secondary" id="btnMeta" disabled>Meta</button>
    <button class="secondary" id="btnSync" disabled>Sync sets</button>
    <button class="danger" id="btnReset" disabled>Reset memoria</button>
    <span id="connBadge" class="badge">DISCONNECTED</span>

    <label class="row" style="margin-left:auto;gap:8px">
      <input id="dbgToggle" type="checkbox">
      <span class="muted">Debug</span>
    </label>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <b>Batteria</b><span id="batBadge" class="badge">‚Äî</span>
  </div>
  <div class="progress"><div id="batBar" class="bar"></div></div>
  <div class="grid">
    <div>Carica</div><div id="batPct">‚Äî</div>
    <div>Tensione</div><div id="batV">‚Äî</div>
    <div>Stato</div><div id="batChg">‚Äî</div>
  </div>
</div>

<div class="card">
  <b>Controlli</b>
  <div class="grid">
    <div>Esercizio</div>
    <div class="row" style="gap:8px">
      <select id="exSelect" style="min-width:220px"></select>
      <button class="secondary" id="btnSetEx" disabled>Invia</button>
    </div>

    <div>Display</div>
    <div class="row" style="gap:8px">
      <button class="secondary" id="btnDispOn" disabled>Display ON</button>
      <button class="secondary" id="btnDispOff" disabled>Display OFF</button>
      <span class="muted" id="dispState">‚Äî</span>
    </div>

    <div>Target RIR</div>
    <div class="row" style="gap:8px">
      <select id="rirSelect">
        <option value="0">0</option><option value="1">1</option><option value="2">2</option>
        <option value="3" selected>3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
      </select>
      <button class="secondary" id="btnSetRIR" disabled>Invia</button>
    </div>
  </div>
  <div class="muted" style="margin-top:10px">
    Durante l‚Äôallenamento: premi il tasto sul device (start) ‚Üí fai la serie ‚Üí premi di nuovo (stop).
  </div>
</div>

<div class="card">
  <b>RAW (CSV IMU)</b>
  <div class="row">
    <button class="secondary" id="btnRawInfo" disabled>Raw list</button>
    <select id="rawSelect" style="min-width:280px" disabled></select>
    <button id="btnRawDl" disabled>Download raw</button>
    <button class="danger" id="btnRawClear" disabled>Clear raw (ESP32)</button>
    <span class="pill" id="rawStatus">‚Äî</span>
  </div>
  <div class="progress"><div id="rawBar" class="bar"></div></div>
  <div class="muted" id="rawHint" style="margin-top:8px">Premi ‚ÄúRaw list‚Äù per vedere i file salvati.</div>
</div>

<div class="card">
  <b>Calibrazione (META)</b>
  <div class="grid">
    <div>A_HIGH</div><div id="calAH">‚Äî</div>
    <div>A_LOW</div><div id="calAL">‚Äî</div>
    <div>DEBOUNCE</div><div id="calDB">‚Äî</div>
    <div>MAX_REP</div><div id="calMR">‚Äî</div>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <b>Sets sincronizzati</b>
    <span class="muted" id="setsCount">0</span>
  </div>
  <div class="muted" id="syncStatus">‚Äî</div>

  <table>
    <thead>
      <tr>
        <th>ID</th><th>Esercizio</th>
        <th class="right">Reps</th>
        <th class="right">TUT</th>
        <th class="right">Qualit√†</th>
        <th class="right">VelLoss</th>
        <th class="right">RomLoss</th>
        <th class="right">Dirty</th>
        <th class="right">RIR</th>
      </tr>
    </thead>
    <tbody id="setsTbody">
      <tr><td colspan="9" class="muted">Premi ‚ÄúSync sets‚Äù ...</td></tr>
    </tbody>
  </table>
</div>

<div class="card hidden" id="debugCard">
  <b>Debug</b>
  <div class="muted">Mostra raw RX/TX (max 8000 chars).</div>
  <div class="mono" id="dbgLog" style="margin-top:10px">-</div>
</div>

<script>
const UUID_SERVICE="b5f90001-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_TX="b5f90002-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_RX="b5f90003-6c3f-4c6b-a5d6-3adfe0c0b6a1";

let dev,server,svc,chTX,chRX;
let sets=new Map();

let jsonBuf="", depth=0, inStr=false, esc=false;
let metaReceived=false;

const $=id=>document.getElementById(id);

function setConn(on){
  const b=$("connBadge");
  b.textContent=on?"CONNECTED":"DISCONNECTED";
  b.className="badge "+(on?"ok":"");
}

$("dbgToggle").addEventListener("change",()=>{
  $("debugCard").classList.toggle("hidden", !$("dbgToggle").checked);
});

function dbgLine(prefix, s){
  if(!$("dbgToggle").checked) return;
  $("dbgLog").textContent=(`${prefix} ${s}\n\n` + $("dbgLog").textContent).slice(0,8000);
}
const dbgTX = (s)=>dbgLine("TX:", s);
const dbgRX = (s)=>dbgLine("RX:", s);

function num(x){ const n=Number(x); return Number.isFinite(n)?n:null; }
function voltFromMaybeMv(v){
  const n=num(v); if(n===null) return null;
  return (n>20)?(n/1000.0):n;
}
function battLabel(vV){
  if(vV===null) return {t:"‚Äî",c:""};
  if(vV>=4.15) return {t:"Piena",c:"ok"};
  if(vV>=3.95) return {t:"Alta",c:"ok"};
  if(vV>=3.80) return {t:"Media",c:"warn"};
  if(vV>=3.65) return {t:"Bassa",c:"warn"};
  return {t:"Critica",c:"bad"};
}
function updateBattery(bat){
  if(!bat) return;
  const pct=num(bat.pct);
  const vV=voltFromMaybeMv(bat.v);
  const chg=(bat.chg===true);

  $("batPct").textContent=(pct===null)?"‚Äî":`${Math.round(pct)}%`;
  $("batV").textContent=(vV===null)?"‚Äî":`${vV.toFixed(3)} V`;
  $("batChg").textContent=chg?"‚ö° In carica (o completata)":"üîã Batteria";
  $("batBar").style.width=(pct===null)?"0%":`${Math.max(0,Math.min(100,pct))}%`;

  const lab=battLabel(vV);
  $("batBadge").textContent=lab.t;
  $("batBadge").className="badge "+lab.c;
}
function updateCal(cal){
  if(!cal) return;
  $("calAH").textContent=(num(cal.A_HIGH)===null)?"‚Äî":Number(cal.A_HIGH).toFixed(4);
  $("calAL").textContent=(num(cal.A_LOW)===null)?"‚Äî":Number(cal.A_LOW).toFixed(4);
  $("calDB").textContent=(num(cal.DEBOUNCE_MS)===null)?"‚Äî":`${cal.DEBOUNCE_MS} ms`;
  $("calMR").textContent=(num(cal.MAX_REP_MS)===null)?"‚Äî":`${cal.MAX_REP_MS} ms`;
}
function updateExercises(list, exIndex){
  if(!Array.isArray(list) || !list.length) return;
  const sel=$("exSelect");
  sel.innerHTML="";
  list.forEach((name,i)=>{
    const opt=document.createElement("option");
    opt.value=String(i);
    opt.textContent=name;
    sel.appendChild(opt);
  });
  if(Number.isInteger(exIndex) && exIndex>=0 && exIndex<list.length) sel.value=String(exIndex);
}

function renderSets(){
  const tbody=$("setsTbody");
  const arr=[...sets.values()].sort((a,b)=>a.id-b.id);
  $("setsCount").textContent=String(arr.length);

  const badge = (q) => {
    if(q===null) return "";
    if(q>=80) return "‚úÖ";
    if(q>=60) return "‚ö†Ô∏è";
    return "üõë";
  };
  const pctHint = (p) => {
    if(p===null) return "";
    if(p>=40) return "üõë";
    if(p>=25) return "‚ö†Ô∏è";
    return "‚úÖ";
  };
  const sec = (t) => (t===null ? "" : `${t.toFixed(1)}s`);

  if(arr.length===0){
    tbody.innerHTML=`<tr><td colspan="9" class="muted">Nessun set ricevuto.</td></tr>`;
    return;
  }

  tbody.innerHTML="";
  for(const s of arr){
    const q=num(s.quality);
    const vl=num(s.velLoss);
    const rl=num(s.romLoss);
    const di=num(s.dirty);
    const tut=num(s.tut_s);

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${s.id??""}</td>
      <td>${s.exercise??""}</td>
      <td class="right">${s.reps??""}</td>
      <td class="right">${sec(tut)}</td>
      <td class="right">${q===null?"":`${badge(q)} ${q.toFixed(1)}`}</td>
      <td class="right">${vl===null?"":`${pctHint(vl)} ${vl.toFixed(1)}%`}</td>
      <td class="right">${rl===null?"":`${pctHint(rl)} ${rl.toFixed(1)}%`}</td>
      <td class="right">${di===null?"":di.toFixed(1)}</td>
      <td class="right">${s.rir_est??""}</td>
    `;
    tbody.appendChild(tr);
  }
}

function setSyncStatus(t){ $("syncStatus").textContent=t; }

// ---- JSON stream parser ----
function feedText(str){
  for(let i=0;i<str.length;i++){
    const ch=str[i];

    if(inStr){
      jsonBuf += ch;
      if(esc){ esc=false; continue; }
      if(ch === "\\"){ esc=true; continue; }
      if(ch === "\""){ inStr=false; }
      continue;
    } else {
      if(ch === "\""){ inStr=true; jsonBuf += ch; continue; }
    }

    if(depth===0){
      if(ch !== "{") continue;
      depth=1;
      jsonBuf="{";
      continue;
    }

    jsonBuf += ch;
    if(ch === "{") depth++;
    else if(ch === "}") depth--;

    if(depth===0){
      const raw=jsonBuf;
      jsonBuf="";
      try{
        const obj=JSON.parse(raw);
        handleObj(obj, raw);
      }catch(e){
        dbgRX("PARSE FAIL raw="+raw.slice(0,200));
      }
    }
  }
}

async function writeCmd(obj){
  const s=JSON.stringify(obj);
  dbgTX(s);
  const enc=new TextEncoder();
  await chRX.writeValue(enc.encode(s));
}

function onNotify(ev){
  const dec=new TextDecoder();
  const chunk=dec.decode(ev.target.value);
  feedText(chunk);
}

// ---------- RAW download state ----------
let rawList = [];
let dl = null; // {name,size,got,parts:Uint8Array[], timer}
const b64ToBytes = (b64)=>{
  const bin = atob(b64);
  const out = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
  return out;
};
function setRawStatus(t){ $("rawStatus").textContent=t; }
function setRawBar(p){ $("rawBar").style.width = `${Math.max(0,Math.min(100,p))}%`; }
function dlResetUI(){ setRawBar(0); setRawStatus("‚Äî"); }
function dlStartTimeout(){
  if(!dl) return;
  clearTimeout(dl.timer);
  dl.timer = setTimeout(()=>{
    setRawStatus("Timeout download (riprovare)");
    dl = null;
    setRawBar(0);
  }, 12000);
}
function saveBytesAsFile(bytes, filename){
  const blob = new Blob([bytes], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename.split("/").pop();
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ---------- handle incoming objects ----------
function handleObj(obj, raw){
  dbgRX(raw);

  if(obj.bat) updateBattery(obj.bat);
  if(obj.type==="bat" && obj.bat) updateBattery(obj.bat);

  if(obj.type==="disp"){
    $("dispState").textContent = obj.on ? "ON" : "OFF";
    return;
  }

  if(obj.type==="hello"){
    if(obj.bat) updateBattery(obj.bat);
    return;
  }

  if(obj.type==="meta"){
    metaReceived=true;
    if(obj.exercises) updateExercises(obj.exercises, obj.exIndex);
    if(obj.cal) updateCal(obj.cal);
    if(Number.isInteger(obj.target_rir)) $("rirSelect").value=String(obj.target_rir);

    $("btnSetEx").disabled=false;
    $("btnSetRIR").disabled=false;

    $("btnRawInfo").disabled=false;
    $("btnRawDl").disabled=false;
    $("btnRawClear").disabled=false;

    $("btnDispOn").disabled=false;
    $("btnDispOff").disabled=false;

    if(obj.bat) updateBattery(obj.bat);
    return;
  }

  // ----- RAW protocol -----
  if(obj.type==="raw_info"){
    rawList = Array.isArray(obj.files) ? obj.files : [];
    const sel=$("rawSelect");
    sel.innerHTML="";
    rawList.sort((a,b)=>String(a.name).localeCompare(String(b.name)));
    rawList.forEach((f)=>{
      const opt=document.createElement("option");
      opt.value = f.name;
      opt.textContent = `${f.name} (${Math.round((f.size||0)/1024)} KB)`;
      sel.appendChild(opt);
    });
    sel.disabled = rawList.length===0;
    setRawStatus(rawList.length?`Trovati ${rawList.length} file`:"Nessun file raw");
    $("rawHint").textContent = rawList.length ? "Seleziona e premi Download." : "Nessun file. Registra una serie.";
    return;
  }

  if(obj.type==="raw_cleared"){
    rawList=[];
    $("rawSelect").innerHTML="";
    $("rawSelect").disabled=true;
    setRawStatus(`RAW cancellati su ESP32 (${obj.n??0})`);
    setRawBar(0);
    setTimeout(async()=>{ try { await writeCmd({cmd:"RAW_INFO"}); } catch(e) {} }, 300);
    return;
  }

  // NEW: begin/end
  if(obj.type==="raw_begin"){
    dl = { name: obj.name, size: obj.size||0, got:0, parts:[], timer:null };
    setRawStatus("Download...");
    setRawBar(0);
    dlStartTimeout();
    return;
  }

  if(obj.type==="raw_chunk"){
    // supporta sia begin/end sia legacy
    if(!dl){
      dl = { name: obj.name, size: 0, got:0, parts:[], timer:null };
    }
    if(obj.name && dl.name && obj.name !== dl.name) return;

    if(typeof obj.b64 === "string"){
      const bytes = b64ToBytes(obj.b64);
      dl.parts.push(bytes);
      dl.got += bytes.length;
    }

    const pct = dl.size ? (dl.got/dl.size*100) : 0;
    setRawBar(dl.size ? pct : 0);
    setRawStatus(dl.size ? `Download ${Math.round(pct)}%` : `Ricevuti ${dl.got}B`);
    dlStartTimeout();

    // legacy done:true
    if(obj.done === true){
      handleObj({type:"raw_end", name: dl.name, seq: obj.seq}, JSON.stringify({type:"raw_end"}));
    }
    return;
  }

  if(obj.type==="raw_end"){
    if(!dl) return;
    clearTimeout(dl.timer);

    let total = 0;
    for(const p of dl.parts) total += p.length;
    const out = new Uint8Array(total);
    let off=0;
    for(const p of dl.parts){ out.set(p, off); off += p.length; }

    setRawBar(100);
    setRawStatus("Salvato ‚úÖ");
    saveBytesAsFile(out, dl.name || (obj.name||"raw.csv"));
    dl = null;
    return;
  }

  if(obj.type==="raw_err"){
    setRawStatus("Errore RAW: "+(obj.msg||""));
    setRawBar(0);
    dl = null;
    return;
  }

  // ----- existing sync flow -----
  if(obj.type==="sync_info"){ onSyncInfo(obj); return; }
  if(obj.type==="miss"){ return; }

  if(obj.type==="cleared"){
    sets = new Map();
    renderSets();
    localStorage.removeItem("salus_last_id");
    setSyncStatus("Device: memoria resettata.");
    return;
  }

  if(typeof obj.id==="number" && obj.exercise){
    sets.set(obj.id, obj);
    renderSets();
    localStorage.setItem("salus_last_id", String(obj.id));
    if(syncActive && pendingId === obj.id){
      clearPending();
      maybeAdvance();
    }
    return;
  }
}

// ---------- SYNC A ----------
let syncActive=false;
let syncFirst=0, syncLast=0;
let syncCurrent=0;
let pendingId=null;
let pendingTimer=null;

function clearPending(){
  if(pendingTimer){ clearTimeout(pendingTimer); pendingTimer=null; }
  pendingId=null;
}
function scheduleTimeout(id){
  clearPending();
  pendingId=id;
  pendingTimer=setTimeout(async()=>{
    if(!syncActive) return;
    await requestSet(id);
  }, 700);
}
async function requestSet(id){
  if(!syncActive) return;
  setSyncStatus(`SYNC: richiedo ID ${id}...`);
  scheduleTimeout(id);
  await writeCmd({cmd:"SYNC_GET", id});
}
function maybeAdvance(){
  if(!syncActive) return;
  while(syncCurrent <= syncLast && sets.has(syncCurrent)) syncCurrent++;
  if(syncCurrent > syncLast){
    syncActive=false;
    clearPending();
    setSyncStatus(`SYNC: completato (${sets.size} set)`);
    return;
  }
  requestSet(syncCurrent);
}
function onSyncInfo(obj){
  syncFirst = Number.isFinite(obj.first_id) ? obj.first_id : 0;
  syncLast  = Number.isFinite(obj.last_id)  ? obj.last_id  : 0;

  if(!obj.count || obj.count===0 || syncLast < syncFirst){
    syncActive=false;
    clearPending();
    setSyncStatus("SYNC: nessun set sul device");
    return;
  }

  const lastStr = localStorage.getItem("salus_last_id");
  const lastLocal = lastStr ? parseInt(lastStr,10) : NaN;

  if (Number.isFinite(lastLocal) && lastLocal > syncLast) {
    localStorage.removeItem("salus_last_id");
    sets = new Map();
    renderSets();
    setSyncStatus("SYNC: rilevato reset device ‚Üí full sync...");
  }

  const lastStr2 = localStorage.getItem("salus_last_id");
  const lastLocal2 = lastStr2 ? parseInt(lastStr2,10) : NaN;
  const start = (Number.isFinite(lastLocal2) ? Math.max(syncFirst, lastLocal2 + 1) : syncFirst);

  if(start > syncLast){
    syncActive=false;
    clearPending();
    setSyncStatus("SYNC: gi√† aggiornato (nessun nuovo set).");
    return;
  }

  syncCurrent = start;
  syncActive=true;
  maybeAdvance();
}

// ---------- UI actions ----------
$("btnConnect").onclick=async()=>{
  metaReceived=false;
  setSyncStatus("‚Äî");
  dlResetUI();

  dev = await navigator.bluetooth.requestDevice({
    filters: [{ services: [UUID_SERVICE] }],
    optionalServices: [UUID_SERVICE]
  });

  server = await dev.gatt.connect();
  svc = await server.getPrimaryService(UUID_SERVICE);
  chTX = await svc.getCharacteristic(UUID_TX);
  chRX = await svc.getCharacteristic(UUID_RX);

  await chTX.startNotifications();
  chTX.addEventListener("characteristicvaluechanged", onNotify);

  $("btnMeta").disabled=false;
  $("btnSync").disabled=false;
  $("btnReset").disabled=false;

  setConn(true);

  await writeCmd({cmd:"HELLO"});
  await writeCmd({cmd:"META"});

  setTimeout(async()=>{ if(!metaReceived){ await writeCmd({cmd:"META"}); } }, 500);
};

$("btnMeta").onclick=async()=>{ await writeCmd({cmd:"META"}); };

$("btnSync").onclick=async()=>{
  setSyncStatus("SYNC: avvio...");
  syncActive=true;
  clearPending();
  await writeCmd({cmd:"SYNC_BEGIN"});
};

$("btnReset").onclick=async()=>{
  const x = prompt("Scrivi RESET per cancellare TUTTI i set dal device:");
  if(x !== "RESET") return;
  setSyncStatus("RESET: in corso...");
  await writeCmd({cmd:"CLEAR_LOG"});
};

$("btnSetEx").onclick=async()=>{
  const i=parseInt($("exSelect").value,10);
  if(Number.isInteger(i)) await writeCmd({cmd:"SET_EX", i});
};
$("btnSetRIR").onclick=async()=>{
  const v=parseInt($("rirSelect").value,10);
  if(Number.isInteger(v)) await writeCmd({cmd:"SET_RIR", v});
};

// RAW UI
$("btnRawInfo").onclick=async()=>{
  dlResetUI();
  setRawStatus("Richiedo lista...");
  await writeCmd({cmd:"RAW_INFO"});
};
$("btnRawDl").onclick=async()=>{
  dlResetUI();
  const name = $("rawSelect").value;
  if(!name){ setRawStatus("Seleziona un file"); return; }
  setRawStatus("Avvio download...");
  await writeCmd({cmd:"RAW_GET", name});
};
$("btnRawClear").onclick=async()=>{
  const x = prompt("Scrivi CLEAR per cancellare TUTTI i RAW dal device:");
  if(x !== "CLEAR") return;
  dlResetUI();
  setRawStatus("Cancellazione...");
  await writeCmd({cmd:"RAW_CLEAR"});
};

// Display toggle
$("btnDispOn").onclick=async()=>{ $("dispState").textContent="..."; await writeCmd({cmd:"DISP", on:true}); };
$("btnDispOff").onclick=async()=>{ $("dispState").textContent="..."; await writeCmd({cmd:"DISP", on:false}); };

// init
setConn(false);
renderSets();
setSyncStatus("‚Äî");
updateExercises(["(in attesa di META...)"], 0);
</script>
</body>
</html>
