<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SalusMotion_BLE</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#6b7280;--line:#e5e7eb;}
    body{font-family:system-ui,Arial;margin:16px;background:var(--bg);color:var(--text)}
    h2{margin:0 0 10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
    button{padding:10px 12px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:800;cursor:pointer}
    button.secondary{background:#fff;color:#111;border:1px solid #111}
    button.danger{background:#fff;color:#dc2626;border:1px solid #dc2626}
    button:disabled{opacity:.45;cursor:not-allowed}
    select,input{padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;background:#eee}
    .badge.ok{background:#e8f8ee;color:#16a34a}
    .badge.warn{background:#fff7e6;color:#f59e0b}
    .badge.bad{background:#ffe9e9;color:#dc2626}
    .grid{display:grid;grid-template-columns:140px 1fr;gap:8px 10px;font-size:14px;margin-top:10px}
    .progress{height:12px;background:#eee;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0%;background:#111;transition:width .2s ease}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.04em}
    .right{text-align:right}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;white-space:pre-wrap}
    .hidden{display:none}
    .pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px;font-weight:800}
  </style>
</head>
<body>
<h2>SalusMotion_BLE</h2>

<div class="card">
  <div class="row">
    <button id="btnConnect">Connect</button>
    <button class="secondary" id="btnMeta" disabled>Meta</button>

    <span id="connBadge" class="badge">DISCONNECTED</span>

    <label class="row" style="margin-left:auto;gap:8px">
      <input id="dbgToggle" type="checkbox">
      <span class="muted">Debug</span>
    </label>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between">
    <b>Batteria</b><span id="batBadge" class="badge">‚Äî</span>
  </div>
  <div class="progress"><div id="batBar" class="bar"></div></div>
  <div class="grid">
    <div>Carica</div><div id="batPct">‚Äî</div>
    <div>Tensione</div><div id="batV">‚Äî</div>
    <div>Stato</div><div id="batChg">‚Äî</div>
  </div>
</div>

<div class="card">
  <b>RAW (CSV IMU)</b>
  <div class="row">
    <button class="secondary" id="btnRawInfo" disabled>Raw list</button>
    <select id="rawSelect" style="min-width:320px" disabled></select>
    <button id="btnRawDl" disabled>Download</button>
    <button class="secondary" id="btnRawDlAll" disabled>Download ALL</button>
    <button class="danger" id="btnRawClear" disabled>Clear raw (ESP32)</button>
    <span class="pill" id="rawStatus">‚Äî</span>
  </div>
  <div class="progress"><div id="rawBar" class="bar"></div></div>
  <div class="muted" id="rawHint" style="margin-top:8px">
    Premi ‚ÄúRaw list‚Äù per vedere i file salvati.
  </div>
</div>

<div class="card hidden" id="debugCard">
  <b>Debug</b>
  <div class="muted">Mostra raw RX/TX (max 8000 chars).</div>
  <div class="mono" id="dbgLog" style="margin-top:10px">-</div>
</div>

<script>
/* =========================
   UUID BLE
========================= */
const UUID_SERVICE="b5f90001-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_TX="b5f90002-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_RX="b5f90003-6c3f-4c6b-a5d6-3adfe0c0b6a1";

/* =========================
   State
========================= */
let dev,server,svc,chTX,chRX;
let metaReceived=false;

let jsonBuf="", depth=0, inStr=false, esc=false;

/* RAW download state */
let rawList = [];
let dl = null;         // {name,size,got,parts:Uint8Array[], timer}
let dlAll = null;      // {queue:[...], idx, running, retriesLeft}

/* =========================
   Helpers UI
========================= */
const $=id=>document.getElementById(id);

function setConn(on){
  const b=$("connBadge");
  b.textContent=on?"CONNECTED":"DISCONNECTED";
  b.className="badge "+(on?"ok":"");
}

$("dbgToggle").addEventListener("change",()=>{
  $("debugCard").classList.toggle("hidden", !$("dbgToggle").checked);
});

function dbgLine(prefix, s){
  if(!$("dbgToggle").checked) return;
  $("dbgLog").textContent=(`${prefix} ${s}\n\n` + $("dbgLog").textContent).slice(0,8000);
}
const dbgTX = (s)=>dbgLine("TX:", s);
const dbgRX = (s)=>dbgLine("RX:", s);

function num(x){ const n=Number(x); return Number.isFinite(n)?n:null; }
function voltFromMaybeMv(v){
  const n=num(v); if(n===null) return null;
  return (n>20)?(n/1000.0):n;
}
function battLabel(vV){
  if(vV===null) return {t:"‚Äî",c:""};
  if(vV>=4.15) return {t:"Piena",c:"ok"};
  if(vV>=3.95) return {t:"Alta",c:"ok"};
  if(vV>=3.80) return {t:"Media",c:"warn"};
  if(vV>=3.65) return {t:"Bassa",c:"warn"};
  return {t:"Critica",c:"bad"};
}
function updateBattery(bat){
  if(!bat) return;
  const pct=num(bat.pct);
  const vV=voltFromMaybeMv(bat.v);
  const chg=(bat.chg===true);

  $("batPct").textContent=(pct===null)?"‚Äî":`${Math.round(pct)}%`;
  $("batV").textContent=(vV===null)?"‚Äî":`${vV.toFixed(3)} V`;
  $("batChg").textContent=chg?"‚ö° In carica (o completata)":"üîã Batteria";
  $("batBar").style.width=(pct===null)?"0%":`${Math.max(0,Math.min(100,pct))}%`;

  const lab=battLabel(vV);
  $("batBadge").textContent=lab.t;
  $("batBadge").className="badge "+lab.c;
}

function setRawStatus(t){ $("rawStatus").textContent=t; }
function setRawBar(p){ $("rawBar").style.width = `${Math.max(0,Math.min(100,p))}%`; }
function dlResetUI(){ setRawBar(0); setRawStatus("‚Äî"); }

/* =========================
   BLE I/O
========================= */
async function writeCmd(obj){
  const s=JSON.stringify(obj);
  dbgTX(s);
  const enc=new TextEncoder();
  await chRX.writeValue(enc.encode(s));
}

function onNotify(ev){
  const dec=new TextDecoder();
  const chunk=dec.decode(ev.target.value);
  feedText(chunk);
}

/* =========================
   JSON stream parser (robusto)
========================= */
function feedText(str){
  for(let i=0;i<str.length;i++){
    const ch=str[i];

    if(inStr){
      jsonBuf += ch;
      if(esc){ esc=false; continue; }
      if(ch === "\\"){ esc=true; continue; }
      if(ch === "\""){ inStr=false; }
      continue;
    } else {
      if(ch === "\""){ inStr=true; jsonBuf += ch; continue; }
    }

    if(depth===0){
      if(ch !== "{") continue;
      depth=1;
      jsonBuf="{";
      continue;
    }

    jsonBuf += ch;
    if(ch === "{") depth++;
    else if(ch === "}") depth--;

    if(depth===0){
      const raw=jsonBuf;
      jsonBuf="";
      try{
        const obj=JSON.parse(raw);
        handleObj(obj, raw);
      }catch(e){
        dbgRX("PARSE FAIL raw="+raw.slice(0,200));
      }
    }
  }
}

/* =========================
   RAW decode + save
========================= */
const b64ToBytes = (b64)=>{
  const bin = atob(b64);
  const out = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
  return out;
};

function saveBytesAsFile(bytes, filename){
  const blob = new Blob([bytes], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename.split("/").pop();
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function dlStartTimeout(ms){
  if(!dl) return;
  clearTimeout(dl.timer);
  dl.timer = setTimeout(()=>{
    setRawStatus("Timeout (retry...)");
    // fallback: segnala errore e lascia che Download ALL faccia retry
    handleDlFail("timeout");
  }, ms);
}

function handleDlFail(reason){
  // chiude dl corrente
  dl = null;
  setRawBar(0);

  // se Download ALL attivo, fai retry automatico
  if(dlAll?.running){
    dlAll.retriesLeft--;
    if(dlAll.retriesLeft >= 0){
      setRawStatus(`Retry... (${reason})`);
      // riprova stesso file
      setTimeout(()=> downloadOne(dlAll.queue[dlAll.idx], true), 350);
      return;
    } else {
      dlAll.running=false;
      setRawStatus(`Download ALL interrotto: ${reason}`);
      $("btnRawDlAll").disabled=false;
      $("btnRawDl").disabled=false;
      return;
    }
  }

  setRawStatus(`Errore download: ${reason}`);
}

/* =========================
   Download ONE / ALL
========================= */
function normRawPath(name){
  if(!name) return "";
  let n = String(name).trim();
  if(!n.startsWith("/")) n = "/" + n;
  // forza sempre /raw/basename
  const base = n.split("/").pop();
  return "/raw/" + base;
}

async function downloadOne(name, fromAll=false){
  if(!chRX) return;

  const path = normRawPath(name);
  if(!path){ setRawStatus("Nome file vuoto"); return; }

  // reset dl e avvia
  dl = { name: path, size: 0, got: 0, parts: [], timer: null };
  setRawStatus(fromAll ? `Download ALL: ${path}` : `Download: ${path}`);
  setRawBar(0);

  // timeout pi√π lungo: BLE a volte √® lenta
  dlStartTimeout(20000);

  await writeCmd({cmd:"RAW_GET", name: path});
}

async function downloadAll(){
  if(!rawList.length){
    setRawStatus("Lista vuota: premi Raw list");
    return;
  }
  if(dlAll?.running) return;

  const queue = rawList.map(f=>normRawPath(f.name)).filter(Boolean);
  if(!queue.length){
    setRawStatus("Nessun file valido");
    return;
  }

  dlAll = { queue, idx: 0, running: true, retriesLeft: 2 };

  $("btnRawDlAll").disabled=true;
  $("btnRawDl").disabled=true;

  setRawStatus(`Download ALL: 0/${queue.length}`);
  setRawBar(0);

  // avvia primo
  await downloadOne(queue[0], true);
}

function advanceAll(){
  if(!dlAll?.running) return;

  dlAll.idx++;
  dlAll.retriesLeft = 2; // reset retry per ogni file

  const total = dlAll.queue.length;
  if(dlAll.idx >= total){
    dlAll.running=false;
    setRawBar(100);
    setRawStatus(`Download ALL completato ‚úÖ (${total} file)`);
    $("btnRawDlAll").disabled=false;
    $("btnRawDl").disabled=false;
    return;
  }

  setRawStatus(`Download ALL: ${dlAll.idx}/${total}`);
  setRawBar(0);
  downloadOne(dlAll.queue[dlAll.idx], true);
}

/* =========================
   handle incoming objects
========================= */
function handleObj(obj, raw){
  dbgRX(raw);

  // battery
  if(obj.bat) updateBattery(obj.bat);
  if(obj.type==="bat" && obj.bat) updateBattery(obj.bat);

  if(obj.type==="hello"){ return; }

  if(obj.type==="meta"){
    metaReceived=true;

    $("btnRawInfo").disabled=false;
    $("btnRawDl").disabled=true;
    $("btnRawDlAll").disabled=true;
    $("btnRawClear").disabled=false;

    return;
  }

  // ---------- RAW protocol ----------
  if(obj.type==="raw_info"){
    rawList = Array.isArray(obj.files) ? obj.files : [];

    // sort by name
    rawList.sort((a,b)=>String(a.name).localeCompare(String(b.name)));

    const sel=$("rawSelect");
    sel.innerHTML="";
    for(const f of rawList){
      const opt=document.createElement("option");
      opt.value = f.name;
      opt.textContent = `${normRawPath(f.name)} (${Math.round((f.size||0)/1024)} KB)`;
      sel.appendChild(opt);
    }

    const has = rawList.length>0;
    sel.disabled = !has;
    $("btnRawDl").disabled = !has;
    $("btnRawDlAll").disabled = !has;

    setRawStatus(has ? `Trovati ${rawList.length} file` : "Nessun file RAW");
    $("rawHint").textContent = has
      ? "Seleziona e premi Download, oppure Download ALL."
      : "Nessun RAW: registra una serie sul device.";

    return;
  }

  if(obj.type==="raw_cleared"){
    rawList=[];
    $("rawSelect").innerHTML="";
    $("rawSelect").disabled=true;
    $("btnRawDl").disabled=true;
    $("btnRawDlAll").disabled=true;
    setRawStatus(`RAW cancellati su ESP32 (${obj.n??0})`);
    setRawBar(0);
    return;
  }

  if(obj.type==="raw_err"){
    clearTimeout(dl?.timer);
    handleDlFail(obj.msg || "raw_err");
    return;
  }

  if(obj.type==="raw_begin"){
    // start download
    const name = normRawPath(obj.name || "");
    if(!dl || (name && dl.name !== name)){
      dl = { name, size: 0, got: 0, parts: [], timer: null };
    }
    dl.size = Number(obj.size)||0;
    dl.got = 0;
    dl.parts = [];

    setRawBar(0);
    setRawStatus(dlAll?.running ? `Download ALL: ${dl.name}` : `Download: ${dl.name}`);
    dlStartTimeout(20000);
    return;
  }

  if(obj.type==="raw_chunk"){
    if(!dl){
      // fallback: crea dl
      dl = { name: normRawPath(obj.name || "raw.csv"), size: 0, got: 0, parts: [], timer: null };
    }

    const nm = normRawPath(obj.name || dl.name);
    if(nm && dl.name && nm !== dl.name) return;

    if(typeof obj.b64 === "string"){
      const bytes = b64ToBytes(obj.b64);
      dl.parts.push(bytes);
      dl.got += bytes.length;
    }

    // progress
    const pct = dl.size ? (dl.got/dl.size*100) : 0;
    setRawBar(dl.size ? pct : 0);
    setRawStatus(dl.size
      ? `${dlAll?.running ? "Download ALL" : "Download"} ${Math.min(99,Math.round(pct))}%`
      : `Ricevuti ${dl.got}B`
    );

    dlStartTimeout(20000);
    return;
  }

  if(obj.type==="raw_end"){
    if(!dl) return;
    clearTimeout(dl.timer);

    // concat
    let total = 0;
    for(const p of dl.parts) total += p.length;
    const out = new Uint8Array(total);
    let off=0;
    for(const p of dl.parts){ out.set(p, off); off += p.length; }

    saveBytesAsFile(out, dl.name || obj.name || "raw.csv");

    // progress bar
    setRawBar(100);
    setRawStatus(dlAll?.running ? `Salvato ‚úÖ (${dl.name})` : "Salvato ‚úÖ");

    dl = null;

    // se ALL ‚Üí prossimo
    if(dlAll?.running){
      // aggiorna barra ‚Äúglobale‚Äù in modo sensato
      const totalN = dlAll.queue.length;
      const doneN = dlAll.idx + 1;
      setRawBar((doneN/totalN)*100);
      setTimeout(()=>advanceAll(), 250);
    }

    return;
  }
}

/* =========================
   UI actions
========================= */
$("btnConnect").onclick=async()=>{
  metaReceived=false;
  dlResetUI();
  setRawStatus("‚Äî");
  rawList=[];
  $("rawSelect").innerHTML="";
  $("rawSelect").disabled=true;

  dev = await navigator.bluetooth.requestDevice({
    filters: [{ services: [UUID_SERVICE] }],
    optionalServices: [UUID_SERVICE]
  });

  server = await dev.gatt.connect();
  svc = await server.getPrimaryService(UUID_SERVICE);
  chTX = await svc.getCharacteristic(UUID_TX);
  chRX = await svc.getCharacteristic(UUID_RX);

  await chTX.startNotifications();
  chTX.addEventListener("characteristicvaluechanged", onNotify);

  $("btnMeta").disabled=false;
  setConn(true);

  await writeCmd({cmd:"HELLO"});
  await writeCmd({cmd:"META"});
};

$("btnMeta").onclick=async()=>{ await writeCmd({cmd:"META"}); };

$("btnRawInfo").onclick=async()=>{
  dlResetUI();
  setRawStatus("Richiedo lista...");
  await writeCmd({cmd:"RAW_INFO"});
};

$("btnRawDl").onclick=async()=>{
  dlResetUI();
  let name = $("rawSelect").value;
  if(!name){ setRawStatus("Seleziona un file"); return; }
  await downloadOne(name, false);
};

$("btnRawDlAll").onclick=async()=>{
  dlResetUI();
  await downloadAll();
};

$("btnRawClear").onclick=async()=>{
  const x = prompt("Scrivi CLEAR per cancellare TUTTI i RAW dal device:");
  if(x !== "CLEAR") return;
  dlResetUI();
  setRawStatus("Cancellazione...");
  await writeCmd({cmd:"RAW_CLEAR"});
};

// init
setConn(false);
</script>
</body>
</html>
