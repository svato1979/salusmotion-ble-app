<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SalusMotion BLE</title>

<style>
:root{
  --bg:#f6f7fb;
  --card:#fff;
  --line:#e5e7eb;
  --text:#111;
  --muted:#6b7280;
  --ok:#16a34a;
  --warn:#f59e0b;
  --bad:#dc2626;
}
body{font-family:system-ui;margin:16px;background:var(--bg);color:var(--text)}
h2{margin:0 0 12px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{padding:10px 14px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:800;cursor:pointer}
button.secondary{background:#fff;color:#111;border:1px solid #111}
button.danger{background:#fff;color:var(--bad);border:1px solid var(--bad)}
button:disabled{opacity:.4;cursor:not-allowed}
.badge{padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;background:#eee}
.badge.ok{background:#e8f8ee;color:var(--ok)}
.badge.warn{background:#fff7e6;color:var(--warn)}
.badge.bad{background:#ffe9e9;color:var(--bad)}
.pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px;font-weight:800}
.progress{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin-top:8px}
.bar{height:100%;width:0%;background:#111;transition:.2s}
.grid{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;font-size:14px;margin-top:10px}
.hidden{display:none}
.muted{font-size:12px;color:var(--muted)}
.tabs{display:flex;gap:8px}
.tab{padding:8px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer}
.tab.active{background:#111;color:#fff;border-color:#111}
.topbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
.spacer{flex:1}
.list{display:flex;flex-direction:column;gap:8px}
.item{border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:flex;justify-content:space-between}
.kpiRow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .label{font-size:12px;color:var(--muted);font-weight:800}
.kpi .value{font-size:22px;font-weight:900}
</style>
</head>

<body>

<h2>SalusMotion BLE</h2>

<div class="topbar">
  <div class="tabs">
    <div class="tab active" id="tabCal">Maintenance</div>
    <div class="tab" id="tabWkt">Workout</div>
  </div>
  <div class="spacer"></div>
  <span id="connBadge" class="badge">DISCONNECTED</span>
</div>

<!-- =================== PAGE MAINTENANCE =================== -->
<div id="pageCal">

<div class="card">
  <div class="row">
    <button id="btnConnect">Connect</button>
    <button class="secondary" id="btnMeta" disabled>Meta</button>
  </div>
</div>

<div class="card">
  <b>RAW (IMU)</b>
  <div class="row">
    <button class="secondary" id="btnRawInfo" disabled>List</button>
    <select id="rawSelect" disabled></select>
    <button id="btnRawDl" disabled>Download</button>
    <button class="secondary" id="btnRawAll" disabled>Download ALL</button>
    <button class="danger" id="btnRawClear" disabled>Clear RAW</button>
    <span id="rawStatus" class="pill">—</span>
  </div>
  <div class="progress"><div id="rawBar" class="bar"></div></div>
</div>

<div class="card">
  <b>LOG (Workout)</b>
  <div class="row">
    <button id="btnLogDl" disabled>Download LOG</button>
    <button class="danger" id="btnLogClear" disabled>Clear LOG</button>
    <button class="danger" id="btnFormat">Format FS</button>
    <span id="logStatus" class="pill">—</span>
  </div>
  <div class="progress"><div id="logBar" class="bar"></div></div>
</div>

</div>

<!-- =================== PAGE WORKOUT =================== -->
<div id="pageWkt" class="hidden">

<div class="kpiRow">
  <div class="kpi"><div class="label">LIVE reps</div><div class="value" id="liveReps">—</div></div>
  <div class="kpi"><div class="label">TUT</div><div class="value" id="liveTut">—</div></div>
  <div class="kpi"><div class="label">Segnale</div><div class="value" id="liveEnv">—</div></div>
  <div class="kpi"><div class="label">Quality</div><div class="value" id="liveQ">—</div></div>
</div>

<div class="card">
  <b>Storico</b>
  <div class="list" id="histList"></div>
</div>

</div>

<script>

/* ================= BLE UUID ================= */
const UUID_SERVICE="b5f90001-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_TX="b5f90002-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_RX="b5f90003-6c3f-4c6b-a5d6-3adfe0c0b6a1";

let dev,server,svc,chTX,chRX;

/* ================= Utils ================= */
const $=id=>document.getElementById(id);
function setConn(on){
  $("connBadge").textContent=on?"CONNECTED":"DISCONNECTED";
  $("connBadge").className="badge "+(on?"ok":"");
}
function b64ToBytes(b64){
  const bin=atob(b64);
  const out=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
  return out;
}
function saveFile(bytes,name){
  const blob=new Blob([bytes],{type:"application/octet-stream"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=name;
  a.click();
  URL.revokeObjectURL(url);
}

/* ================= JSON parser robust ================= */
let buf="",depth=0,inStr=false,esc=false;
function feed(str){
  for(const ch of str){
    if(inStr){
      buf+=ch;
      if(esc){esc=false;continue;}
      if(ch==="\\"){esc=true;continue;}
      if(ch==="\"") inStr=false;
      continue;
    }
    if(ch==="\""){inStr=true;buf+=ch;continue;}
    if(depth===0){
      if(ch!=="{") continue;
      depth=1;buf="{";continue;
    }
    buf+=ch;
    if(ch==="{") depth++;
    if(ch==="}") depth--;
    if(depth===0){
      try{handle(JSON.parse(buf));}catch{}
      buf="";
    }
  }
}

/* ================= BLE connect ================= */
$("btnConnect").onclick=async()=>{
  dev=await navigator.bluetooth.requestDevice({filters:[{services:[UUID_SERVICE]}]});
  server=await dev.gatt.connect();
  svc=await server.getPrimaryService(UUID_SERVICE);
  chTX=await svc.getCharacteristic(UUID_TX);
  chRX=await svc.getCharacteristic(UUID_RX);
  await chTX.startNotifications();
  chTX.addEventListener("characteristicvaluechanged",e=>{
    const d=new TextDecoder().decode(e.target.value);
    feed(d);
  });
  setConn(true);
  $("btnMeta").disabled=false;
  await send({cmd:"META"});
};
$("btnMeta").onclick=()=>send({cmd:"META"});

async function send(o){
  const enc=new TextEncoder();
  await chRX.writeValue(enc.encode(JSON.stringify(o)));
}

/* ================= RAW ================= */
let rawList=[];
let rawDl=null;

$("btnRawInfo").onclick=()=>send({cmd:"RAW_INFO"});
$("btnRawDl").onclick=()=>send({cmd:"RAW_GET",name:$("rawSelect").value});
$("btnRawClear").onclick=()=>{
  if(prompt("Scrivi CLEAR")!=="CLEAR") return;
  send({cmd:"RAW_CLEAR"});
};
$("btnRawAll").onclick=async()=>{
  for(const f of rawList){
    await send({cmd:"RAW_GET",name:f.name});
  }
};

/* ================= LOG ================= */
let logDl=null;

$("btnLogDl").onclick=()=>send({cmd:"LOG_GET"});
$("btnLogClear").onclick=()=>{
  if(prompt("Scrivi CLEAR")!=="CLEAR") return;
  send({cmd:"LOG_CLEAR"});
};
$("btnFormat").onclick=()=>{
  if(prompt("Scrivi FORMAT")!=="FORMAT") return;
  send({cmd:"FS_FORMAT"});
};

/* ================= Handle incoming ================= */
function handle(o){

if(o.type==="meta"){
  $("btnRawInfo").disabled=false;
  $("btnRawClear").disabled=false;
  $("btnLogDl").disabled=false;
  $("btnLogClear").disabled=false;
}

if(o.type==="raw_info"){
  rawList=o.files||[];
  const sel=$("rawSelect");
  sel.innerHTML="";
  rawList.forEach(f=>{
    const opt=document.createElement("option");
    opt.value=f.name;
    opt.textContent=f.name;
    sel.appendChild(opt);
  });
  sel.disabled=!rawList.length;
  $("btnRawDl").disabled=!rawList.length;
  $("btnRawAll").disabled=!rawList.length;
}

if(o.type==="raw_begin"){
  rawDl={size:o.size,got:0,parts:[]};
}
if(o.type==="raw_chunk" && rawDl){
  const bytes=b64ToBytes(o.b64);
  rawDl.parts.push(bytes);
  rawDl.got+=bytes.length;
  $("rawBar").style.width=(rawDl.got/rawDl.size*100)+"%";
}
if(o.type==="raw_end" && rawDl){
  let total=0;
  rawDl.parts.forEach(p=>total+=p.length);
  const out=new Uint8Array(total);
  let off=0;
  rawDl.parts.forEach(p=>{out.set(p,off);off+=p.length;});
  saveFile(out,o.name||"raw.bin");
  rawDl=null;
  $("rawBar").style.width="100%";
  $("rawStatus").textContent="OK";
}

if(o.type==="log_begin"){
  logDl={size:o.size,got:0,parts:[]};
}
if(o.type==="log_chunk" && logDl){
  const bytes=b64ToBytes(o.b64);
  logDl.parts.push(bytes);
  logDl.got+=bytes.length;
  $("logBar").style.width=(logDl.got/logDl.size*100)+"%";
}
if(o.type==="log_end" && logDl){
  let total=0;
  logDl.parts.forEach(p=>total+=p.length);
  const out=new Uint8Array(total);
  let off=0;
  logDl.parts.forEach(p=>{out.set(p,off);off+=p.length;});
  saveFile(out,"sets.jsonl");
  logDl=null;
  $("logBar").style.width="100%";
  $("logStatus").textContent="OK";
}

if(o.type==="fs_formatted"){
  $("rawSelect").innerHTML="";
  rawList=[];
  $("rawBar").style.width="0%";
  $("logBar").style.width="0%";
  $("logStatus").textContent="Formatted";
}

if(o.type==="live"){
  $("liveReps").textContent=o.reps??"—";
  $("liveTut").textContent=o.tut_s??"—";
  $("liveEnv").textContent=o.cnv??"—";
}

if(o.type==="set"){
  const div=document.createElement("div");
  div.className="item";
  div.innerHTML=`<b>${o.exercise||""}</b> reps ${o.reps} Q ${o.quality}`;
  $("histList").prepend(div);
}

}

/* ================= Tabs ================= */
$("tabCal").onclick=()=>{
  $("pageCal").classList.remove("hidden");
  $("pageWkt").classList.add("hidden");
  $("tabCal").classList.add("active");
  $("tabWkt").classList.remove("active");
};
$("tabWkt").onclick=()=>{
  $("pageCal").classList.add("hidden");
  $("pageWkt").classList.remove("hidden");
  $("tabCal").classList.remove("active");
  $("tabWkt").classList.add("active");
};

setConn(false);

</script>
</body>
</html>
