<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SalusMotion_BLE</title>

<style>
body{
  font-family:system-ui,Arial;
  margin:16px;
  background:#f6f6f6;
}

h2{margin-bottom:10px}

.row{display:flex;gap:10px;flex-wrap:wrap}

.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin:14px 0;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
}

button{
  padding:10px 14px;
  border-radius:12px;
  border:0;
  background:#111;
  color:#fff;
  font-weight:600;
}

button.secondary{
  background:#fff;
  color:#111;
  border:1px solid #111;
}

button:disabled{
  opacity:.4;
}

.mono{
  font-family:ui-monospace,Menlo,monospace;
  white-space:pre-wrap;
}

.progress{
  height:14px;
  background:#eee;
  border-radius:20px;
  overflow:hidden;
}

.progress-bar{
  height:100%;
  width:0%;
  background:#4caf50;
  transition:width .3s ease;
}

.grid2{
  display:grid;
  grid-template-columns:120px 1fr;
  row-gap:8px;
  column-gap:10px;
  font-size:14px;
}
.small{font-size:12px;opacity:.7}
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.green{background:#e8f5e9;color:#2e7d32}
.orange{background:#fff3e0;color:#ef6c00}
.red{background:#ffebee;color:#c62828}
.gray{background:#eee;color:#555}
</style>
</head>

<body>

<h2>SalusMotion_BLE</h2>

<div class="row">
  <button id="btnConnect">Connect</button>
  <button class="secondary" id="btnMeta" disabled>Meta</button>
  <button class="secondary" id="btnSync" disabled>Sync Sets</button>
</div>

<!-- BATTERY CARD -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <b>Battery</b>
    <span id="batBadge" class="badge gray">—</span>
  </div>

  <div style="margin-top:12px" class="progress">
    <div id="batBar" class="progress-bar"></div>
  </div>

  <div class="grid2" style="margin-top:12px">
    <div>Percentuale</div>
    <div id="batPct">—</div>

    <div>Tensione</div>
    <div id="batVolt">—</div>

    <div>Charging</div>
    <div id="batChg">—</div>
  </div>

  <div class="small" style="margin-top:10px">
    Nota: su StickC V2 "charging" può non essere affidabile. La tensione è il dato più importante.
  </div>
</div>

<!-- LAST SET -->
<div class="card">
  <b>Last Set</b>
  <div class="grid2" style="margin-top:12px">
    <div>Esercizio</div><div id="setEx">—</div>
    <div>Reps</div><div id="setReps">—</div>
    <div>Quality</div><div id="setQuality">—</div>
    <div>VelLoss</div><div id="setVL">—</div>
    <div>RomLoss</div><div id="setRL">—</div>
    <div>Dirty</div><div id="setDirty">—</div>
  </div>
</div>

<!-- LOG -->
<div class="card">
  <b>Log</b>
  <div class="mono" id="log">-</div>
</div>

<script>

const UUID_SERVICE = "b5f90001-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_TX      = "b5f90002-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_RX      = "b5f90003-6c3f-4c6b-a5d6-3adfe0c0b6a1";

let dev, server, svc, chTX, chRX;
let rxBuf = "";

const $log = document.getElementById("log");

function logLine(s){
  $log.textContent = (s + "\n\n" + $log.textContent).slice(0, 4000);
}

function updateBattery(bat){
  if(!bat) return;

  const pct = Number(bat.pct ?? 0);
  const v   = Number(bat.v ?? 0);
  const chg = bat.chg === true;

  document.getElementById("batPct").textContent = pct + "%";
  document.getElementById("batVolt").textContent = v.toFixed(2) + " V";
  document.getElementById("batChg").textContent = chg ? "⚡ In carica" : "Non in carica";

  const bar = document.getElementById("batBar");
  bar.style.width = pct + "%";

  const badge = document.getElementById("batBadge");

  if(v >= 4.15){
    badge.textContent = "Piena";
    badge.className = "badge green";
  }else if(v >= 3.9){
    badge.textContent = "Buona";
    badge.className = "badge green";
  }else if(v >= 3.7){
    badge.textContent = "Media";
    badge.className = "badge orange";
  }else{
    badge.textContent = "Bassa";
    badge.className = "badge red";
  }
}

function updateSet(obj){
  document.getElementById("setEx").textContent = obj.exercise ?? "-";
  document.getElementById("setReps").textContent = obj.reps ?? "-";
  document.getElementById("setQuality").textContent = obj.quality?.toFixed(1) ?? "-";
  document.getElementById("setVL").textContent = obj.velLoss?.toFixed(1) + "%" ?? "-";
  document.getElementById("setRL").textContent = obj.romLoss?.toFixed(1) + "%" ?? "-";
  document.getElementById("setDirty").textContent = obj.dirty?.toFixed(1) ?? "-";
}

function handleJsonLine(line){
  line = line.trim();
  if(!line) return;

  try{
    const obj = JSON.parse(line);

    if(obj.bat) updateBattery(obj.bat);

    if(typeof obj.id === "number" && obj.exercise){
      updateSet(obj);
    }

    logLine(line);

  }catch(e){
    logLine("Parse error");
  }
}

function onNotify(ev){
  const dec = new TextDecoder();
  const chunk = dec.decode(ev.target.value);
  rxBuf += chunk;

  let idx;
  while((idx = rxBuf.indexOf("\n")) >= 0){
    const line = rxBuf.slice(0, idx);
    rxBuf = rxBuf.slice(idx+1);
    handleJsonLine(line);
  }
}

async function writeCmd(obj){
  const s = JSON.stringify(obj);
  const enc = new TextEncoder();
  await chRX.writeValue(enc.encode(s));
}

document.getElementById("btnConnect").onclick = async ()=>{
  try{
    dev = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [UUID_SERVICE]
    });

    server = await dev.gatt.connect();
    svc = await server.getPrimaryService(UUID_SERVICE);
    chTX = await svc.getCharacteristic(UUID_TX);
    chRX = await svc.getCharacteristic(UUID_RX);

    await chTX.startNotifications();
    chTX.addEventListener("characteristicvaluechanged", onNotify);

    document.getElementById("btnMeta").disabled = false;
    document.getElementById("btnSync").disabled = false;

    logLine("CONNECTED ✅");

    await writeCmd({cmd:"HELLO"});
    await writeCmd({cmd:"META"});

  }catch(e){
    logLine("Connect error: " + e);
  }
};

document.getElementById("btnMeta").onclick = async ()=>{
  await writeCmd({cmd:"META"});
};

document.getElementById("btnSync").onclick = async ()=>{
  await writeCmd({cmd:"GET_SETS", from:0});
  logLine("Sync started...");
};

</script>
</body>
</html>
