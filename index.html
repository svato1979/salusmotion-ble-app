<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SalusMotion_BLE</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#111;--muted:#6b7280;--line:#e5e7eb;
      --ok:#16a34a;--warn:#f59e0b;--bad:#dc2626;
    }
    body{font-family:system-ui,Arial;margin:16px;background:var(--bg);color:var(--text)}
    h2{margin:0 0 10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
    button{padding:10px 12px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:800;cursor:pointer}
    button.secondary{background:#fff;color:#111;border:1px solid #111}
    button.danger{background:#fff;color:#dc2626;border:1px solid #dc2626}
    button:disabled{opacity:.45;cursor:not-allowed}
    select,input{padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;background:#eee}
    .badge.ok{background:#e8f8ee;color:var(--ok)}
    .badge.warn{background:#fff7e6;color:var(--warn)}
    .badge.bad{background:#ffe9e9;color:var(--bad)}
    .grid{display:grid;grid-template-columns:140px 1fr;gap:8px 10px;font-size:14px;margin-top:10px}
    .progress{height:12px;background:#eee;border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0%;background:#111;transition:width .2s ease}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;white-space:pre-wrap}
    .hidden{display:none}
    .pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px;font-weight:800}

    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 14px 0}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;color:#111;font-weight:900;cursor:pointer;
    }
    .tab.active{background:#111;color:#fff;border-color:#111}
    .spacer{flex:1}
    .kpiRow{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}
    @media (max-width:900px){ .kpiRow{grid-template-columns:repeat(2,minmax(160px,1fr));} }
    .kpi{
      border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;
      display:flex;flex-direction:column;gap:6px;
    }
    .kpi .label{font-size:12px;color:var(--muted);font-weight:800}
    .kpi .value{font-size:26px;font-weight:1000;line-height:1}
    .kpi .sub{font-size:12px;color:var(--muted);font-weight:800}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .item .left{display:flex;flex-direction:column;gap:2px}
    .item .title{font-weight:1000}
    .item .meta{font-size:12px;color:var(--muted);font-weight:800}
    .item .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .miniBtn{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:900}
    .miniBtn.secondary{background:#fff;color:#111;border:1px solid #111}
    .miniBtn.danger{background:#fff;color:var(--bad);border:1px solid var(--bad)}
    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;align-items:center;justify-content:center;padding:16px;
    }
    .modal.open{display:flex}
    .sheet{
      width:min(860px,100%);background:#fff;border-radius:20px;border:1px solid var(--line);
      padding:14px;
    }
    .sheetHeader{display:flex;align-items:center;gap:10px}
    .sheetHeader .title{font-weight:1000;font-size:16px}
    .sheetBody{margin-top:10px}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .sparkWrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    svg{display:block}
  </style>
</head>

<body>
  <h2>SalusMotion_BLE</h2>

  <div class="topbar">
    <div class="tabs">
      <button class="tab active" id="tabCal">Calibrazione</button>
      <button class="tab" id="tabWkt" disabled>Workout</button>
    </div>

    <div class="spacer"></div>

    <span id="quickConn" class="badge">DISCONNECTED</span>
    <span id="quickEx" class="pill">‚Äî</span>
  </div>

  <!-- PAGE 1 -->
  <div id="pageCal">

    <div class="card">
      <div class="row">
        <button id="btnConnect">Connect</button>
        <button class="secondary" id="btnMeta" disabled>Meta</button>
        <span id="connBadge" class="badge">DISCONNECTED</span>

        <label class="row" style="margin-left:auto;gap:8px">
          <input id="dbgToggle" type="checkbox">
          <span class="muted">Debug</span>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Batteria</b><span id="batBadge" class="badge">‚Äî</span>
      </div>

      <div class="progress"><div id="batBar" class="bar"></div></div>

      <div class="grid">
        <div>Carica</div><div id="batPct">‚Äî</div>
        <div>Tensione</div><div id="batV">‚Äî</div>
        <div>Stato</div><div id="batChg">‚Äî</div>
      </div>
    </div>

    <div class="card" id="exCard">
      <div class="row" style="justify-content:space-between; align-items:center">
        <b>Esercizio</b>
        <span id="exBadge" class="badge">‚Äî</span>
      </div>

      <div class="row" style="margin-top:10px">
        <select id="exSelect" style="min-width:320px" disabled></select>
        <button class="secondary" id="btnSetEx" disabled>Set</button>

        <span style="flex:1"></span>

        <button class="secondary" id="btnDisp" disabled>Schermo OFF</button>
        <span id="dispBadge" class="badge">‚Äî</span>
      </div>

      <div class="muted" style="margin-top:8px">
        Seleziona l‚Äôesercizio e premi <b>Set</b> per impostarlo sul device.
      </div>
    </div>

    <div class="card">
      <b>RAW (CSV IMU)</b>
      <div class="row">
        <button class="secondary" id="btnRawInfo" disabled>Raw list</button>
        <select id="rawSelect" style="min-width:320px" disabled></select>
        <button id="btnRawDl" disabled>Download</button>
        <button class="secondary" id="btnRawDlAll" disabled>Download ALL</button>
        <button class="danger" id="btnRawClear" disabled>Clear raw (ESP32)</button>
        <span class="pill" id="rawStatus">‚Äî</span>
      </div>

      <div class="progress"><div id="rawBar" class="bar"></div></div>

      <div class="muted" id="rawHint" style="margin-top:8px">
        Premi ‚ÄúRaw list‚Äù per vedere i file salvati.
      </div>
    </div>

    <div class="card">
      <b>Workout LOG (sets.jsonl)</b>
      <div class="row">
        <button id="btnLogDl" disabled>Download LOG</button>
        <button class="danger" id="btnLogClear" disabled>Clear LOG</button>
      </div>
      <div class="muted" style="margin-top:6px">
        Contiene tutti i set salvati nel device (JSONL).
      </div>
    </div>

    <div class="card">
      <b>System</b>
      <div class="row">
        <button class="danger" id="btnFormat" disabled>Format FS (ALL)</button>
      </div>
      <div class="muted" style="margin-top:6px">
        Cancella RAW + LOG + reset next_id / ack_id.
      </div>
    </div>

    <div class="card hidden" id="debugCard">
      <b>Debug</b>
      <div class="muted">Mostra raw RX/TX (max 8000 chars).</div>
      <div class="mono" id="dbgLog" style="margin-top:10px">-</div>
    </div>

  </div>

  <!-- PAGE 2 -->
  <div id="pageWkt" class="hidden">

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="display:flex;flex-direction:column;gap:4px">
          <b>Workout</b>
          <div class="muted">LIVE + ultimo set + storico (salvato nel browser).</div>
        </div>

        <div class="row" style="gap:8px">
          <button class="secondary miniBtn" id="btnExportJson">Export JSON</button>
          <button class="secondary miniBtn" id="btnExportCsv">Export CSV</button>
          <button class="danger miniBtn" id="btnClearHistory">Clear storico</button>
        </div>
      </div>
    </div>

    <div class="kpiRow">
      <div class="kpi">
        <div class="label">LIVE reps</div>
        <div class="value" id="liveReps">‚Äî</div>
        <div class="sub" id="liveEx">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">TUT live</div>
        <div class="value" id="liveTut">‚Äî</div>
        <div class="sub" id="livePhase">phase ‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">Segnale (cnv/env)</div>
        <div class="value" id="liveEnv">‚Äî</div>
        <div class="sub" id="liveThr">thr ‚Äî / ‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">Qualit√† (ultimo set)</div>
        <div class="value" id="lastQ">‚Äî</div>
        <div class="sub sparkWrap">
          <span class="pill" id="lastBadge">‚Äî</span>
          <svg id="spark" width="140" height="26" viewBox="0 0 140 26" aria-label="trend qualit√†"></svg>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>Ultimo set</b>
        <span id="lastSetMini" class="pill">‚Äî</span>
      </div>

      <div class="grid">
        <div>Esercizio</div><div id="lastExercise">‚Äî</div>
        <div>Reps</div><div id="lastReps">‚Äî</div>
        <div>TUT</div><div id="lastTut">‚Äî</div>
        <div>Quality</div><div id="lastQuality">‚Äî</div>
        <div>VelLoss</div><div id="lastVel">‚Äî</div>
        <div>RomLoss</div><div id="lastRom">‚Äî</div>
        <div>RIR est / target</div><div id="lastRir">‚Äî</div>
        <div>RAW file</div><div id="lastRaw">‚Äî</div>
      </div>

      <div class="muted" id="lastHint" style="margin-top:8px">
        Quando il FW manda <code>{"type":"set"...}</code>, qui compare il riepilogo.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>Sets salvati</b>
        <span class="pill" id="histCount">0</span>
      </div>
      <div class="muted" style="margin-top:6px">
        Click su un set per aprire il dettaglio. (Persistente nel browser)
      </div>

      <div class="divider"></div>

      <div class="list" id="histList"></div>
      <div class="muted" id="histEmpty" style="margin-top:10px">Nessun set ancora.</div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHeader">
        <div class="title" id="mTitle">Dettaglio set</div>
        <span class="spacer"></span>
        <button class="secondary miniBtn" id="btnCloseModal">Chiudi</button>
      </div>
      <div class="sheetBody">
        <div class="grid" id="mGrid"></div>
      </div>
    </div>
  </div>

<script>
/* ========================= UUID BLE ========================= */
const UUID_SERVICE="b5f90001-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_TX="b5f90002-6c3f-4c6b-a5d6-3adfe0c0b6a1";
const UUID_RX="b5f90003-6c3f-4c6b-a5d6-3adfe0c0b6a1";

/* ========================= State ========================= */
let dev=null, server=null, svc=null, chTX=null, chRX=null;
let metaReceived=false;
let meta=null;
let dispOn=true;

// robust JSON stream parser
let jsonBuf="", depth=0, inStr=false, esc=false;

// RAW download state
let rawList = [];
let dl = null;     // {name,size,got,parts:Uint8Array[], timer}
let dlAll = null;  // {queue:[...], idx, running, retriesLeft}

// LOG download state
let logDl = null;  // {parts:[], size, got}

/* ========================= Workout state (Page2) ========================= */
const STORE_KEY = "salusmotion_sets_v1";
let sets = loadSets();
let lastSet = null;
let live = { reps:null, tut_s:null, cnv:null, thr_hi:null, thr_lo:null, phase:null, exercise:null, exindex:null };

/* ========================= Helpers ========================= */
const $ = (id)=>document.getElementById(id);

function isConnected(){
  return !!(dev && dev.gatt && dev.gatt.connected && chRX && chTX);
}

function setConn(on){
  $("connBadge").textContent = on ? "CONNECTED" : "DISCONNECTED";
  $("connBadge").className = "badge " + (on ? "ok" : "");

  $("quickConn").textContent = on ? "CONNECTED" : "DISCONNECTED";
  $("quickConn").className = "badge " + (on ? "ok" : "");

  $("tabWkt").disabled = !on;
}

function setQuickExercise(name){
  $("quickEx").textContent = name || "‚Äî";
}

$("dbgToggle").addEventListener("change",()=>{
  $("debugCard").classList.toggle("hidden", !$("dbgToggle").checked);
});

function dbgLine(prefix, s){
  if(!$("dbgToggle").checked) return;
  $("dbgLog").textContent = (`${prefix} ${s}\n\n` + $("dbgLog").textContent).slice(0,8000);
}
const dbgTX = (s)=>dbgLine("TX:", s);
const dbgRX = (s)=>dbgLine("RX:", s);

function num(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : null;
}

function voltFromMaybeMv(v){
  const n = num(v);
  if(n===null) return null;
  return (n>20) ? (n/1000.0) : n;
}

function battLabel(vV){
  if(vV===null) return {t:"‚Äî",c:""};
  if(vV>=4.15) return {t:"Piena",c:"ok"};
  if(vV>=3.95) return {t:"Alta",c:"ok"};
  if(vV>=3.80) return {t:"Media",c:"warn"};
  if(vV>=3.65) return {t:"Bassa",c:"warn"};
  return {t:"Critica",c:"bad"};
}

function updateBattery(bat){
  if(!bat) return;
  const pct=num(bat.pct);
  const vV=voltFromMaybeMv(bat.v);
  const chg=(bat.chg===true);

  $("batPct").textContent = (pct===null) ? "‚Äî" : (Math.round(pct) + "%");
  $("batV").textContent   = (vV===null)  ? "‚Äî" : (vV.toFixed(3) + " V");
  $("batChg").textContent = chg ? "‚ö° In carica (o completata)" : "üîã Batteria";
  $("batBar").style.width = (pct===null) ? "0%" : (Math.max(0,Math.min(100,pct)) + "%");

  const lab=battLabel(vV);
  $("batBadge").textContent=lab.t;
  $("batBadge").className="badge "+lab.c;
}

function setRawStatus(t){ $("rawStatus").textContent=t; }
function setRawBar(p){ $("rawBar").style.width = (Math.max(0,Math.min(100,p)) + "%"); }
function dlResetUI(){ setRawBar(0); setRawStatus("‚Äî"); }

function fillExercises(exercises, exIndex){
  const sel = $("exSelect");
  sel.innerHTML = "";
  (exercises || []).forEach((name, i)=>{
    const opt=document.createElement("option");
    opt.value = String(i);
    opt.textContent = name;
    sel.appendChild(opt);
  });

  const ok = !!(exercises && exercises.length);
  sel.disabled = !ok;
  $("btnSetEx").disabled = !ok;

  if(typeof exIndex === "number" && exIndex >= 0 && ok){
    sel.value = String(exIndex);
  }

  const cur = ok ? exercises[Number(sel.value)] : null;
  $("exBadge").textContent = cur ? cur : "‚Äî";
  setQuickExercise(cur);
}

function setDispUI(on){
  dispOn = !!on;
  $("dispBadge").textContent = dispOn ? "ON" : "OFF";
  $("dispBadge").className = "badge " + (dispOn ? "ok" : "warn");
  $("btnDisp").textContent = dispOn ? "Schermo OFF" : "Schermo ON";
}

/* ========================= Tabs ========================= */
function showPage(which){
  const isWkt = (which === "wkt");
  $("pageCal").classList.toggle("hidden", isWkt);
  $("pageWkt").classList.toggle("hidden", !isWkt);
  $("tabCal").classList.toggle("active", !isWkt);
  $("tabWkt").classList.toggle("active", isWkt);

  if(isWkt){
    renderHistory();
    renderLive();
    renderLastSet();
  }
}
$("tabCal").onclick = ()=>showPage("cal");
$("tabWkt").onclick = ()=>showPage("wkt");

/* ========================= BLE I/O ========================= */
async function writeCmd(obj){
  if(!isConnected()){
    setRawStatus("Non connesso");
    throw new Error("BLE not connected");
  }
  const s = JSON.stringify(obj);
  dbgTX(s);
  const enc = new TextEncoder();
  await chRX.writeValue(enc.encode(s));
}

function onNotify(ev){
  const dec = new TextDecoder();
  const chunk = dec.decode(ev.target.value);
  feedText(chunk);
}

function onDisconnected(){
  // reset handles
  server=null; svc=null; chTX=null; chRX=null;
  metaReceived=false; meta=null;
  dl=null; dlAll=null; logDl=null;

  // UI reset
  setConn(false);
  $("btnMeta").disabled=true;

  $("btnRawInfo").disabled=true;
  $("btnRawDl").disabled=true;
  $("btnRawDlAll").disabled=true;
  $("btnRawClear").disabled=true;
  $("rawSelect").disabled=true;
  $("rawSelect").innerHTML="";
  setRawStatus("DISCONNECTED");
  setRawBar(0);

  $("btnLogDl").disabled=true;
  $("btnLogClear").disabled=true;
  $("btnFormat").disabled=true;

  $("exSelect").disabled=true;
  $("exSelect").innerHTML="";
  $("btnSetEx").disabled=true;
  $("exBadge").textContent="‚Äî";

  $("btnDisp").disabled=true;
  $("dispBadge").textContent="‚Äî";
  setQuickExercise("‚Äî");
}

/* ========================= JSON stream parser ========================= */
function feedText(str){
  for(let i=0;i<str.length;i++){
    const ch=str[i];

    if(inStr){
      jsonBuf += ch;
      if(esc){ esc=false; continue; }
      if(ch === "\\"){ esc=true; continue; }
      if(ch === "\""){ inStr=false; }
      continue;
    }else{
      if(ch === "\""){ inStr=true; jsonBuf += ch; continue; }
    }

    if(depth===0){
      if(ch !== "{") continue;
      depth=1;
      jsonBuf="{";
      continue;
    }

    jsonBuf += ch;
    if(ch === "{") depth++;
    else if(ch === "}") depth--;

    if(depth===0){
      const raw=jsonBuf;
      jsonBuf="";
      try{
        const obj=JSON.parse(raw);
        handleObj(obj, raw);
      }catch(e){
        dbgRX("PARSE FAIL raw="+raw.slice(0,220));
      }
    }
  }
}

/* ========================= RAW/LOG helpers ========================= */
const b64ToBytes = (b64)=>{
  const bin = atob(b64);
  const out = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i);
  return out;
};

function saveBytesAsFile(bytes, filename){
  const isBin = String(filename).toLowerCase().endsWith(".bin");
  const mime = isBin ? "application/octet-stream" : "text/csv";
  const blob = new Blob([bytes], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = String(filename).split("/").pop();
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function dlStartTimeout(ms){
  if(!dl) return;
  clearTimeout(dl.timer);
  dl.timer = setTimeout(()=>{
    setRawStatus("Timeout (retry...)");
    handleDlFail("timeout");
  }, ms);
}

function handleDlFail(reason){
  dl = null;
  setRawBar(0);

  if(dlAll && dlAll.running){
    dlAll.retriesLeft--;
    if(dlAll.retriesLeft >= 0){
      setRawStatus(`Retry... (${reason})`);
      setTimeout(()=> downloadOne(dlAll.queue[dlAll.idx], true).catch(()=>{}), 350);
      return;
    }else{
      dlAll.running=false;
      setRawStatus(`Download ALL interrotto: ${reason}`);
      $("btnRawDlAll").disabled=false;
      $("btnRawDl").disabled=false;
      return;
    }
  }

  setRawStatus(`Errore download: ${reason}`);
}

function normRawPath(name){
  if(!name) return "";
  let n = String(name).trim();
  if(!n.startsWith("/")) n = "/" + n;
  const base = n.split("/").pop();
  return "/raw/" + base;
}

/* ========================= Download ONE / ALL ========================= */
async function downloadOne(name, fromAll=false){
  const path = normRawPath(name);
  if(!path){ setRawStatus("Nome file vuoto"); return; }

  dl = { name: path, size: 0, got: 0, parts: [], timer: null };
  setRawStatus(fromAll ? `Download ALL: ${path}` : `Download: ${path}`);
  setRawBar(0);
  dlStartTimeout(20000);

  await writeCmd({cmd:"RAW_GET", name: path});
}

async function downloadAll(){
  if(!rawList.length){
    setRawStatus("Lista vuota: premi Raw list");
    return;
  }
  if(dlAll && dlAll.running) return;

  const queue = rawList.map(f=>normRawPath(f.name)).filter(Boolean);
  if(!queue.length){
    setRawStatus("Nessun file valido");
    return;
  }

  dlAll = { queue, idx: 0, running: true, retriesLeft: 2 };
  $("btnRawDlAll").disabled=true;
  $("btnRawDl").disabled=true;
  setRawStatus(`Download ALL: 0/${queue.length}`);
  setRawBar(0);

  await downloadOne(queue[0], true);
}

function advanceAll(){
  if(!dlAll || !dlAll.running) return;
  dlAll.idx++;
  dlAll.retriesLeft = 2;

  const total = dlAll.queue.length;
  if(dlAll.idx >= total){
    dlAll.running=false;
    setRawBar(100);
    setRawStatus(`Download ALL completato ‚úÖ (${total} file)`);
    $("btnRawDlAll").disabled=false;
    $("btnRawDl").disabled=false;
    return;
  }

  setRawStatus(`Download ALL: ${dlAll.idx}/${total}`);
  setRawBar(0);
  downloadOne(dlAll.queue[dlAll.idx], true).catch(()=>{});
}

/* ========================= WORKOUT: storage + UI ========================= */
function loadSets(){
  try{
    const s = localStorage.getItem(STORE_KEY);
    const arr = s ? JSON.parse(s) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function saveSets(){
  try{ localStorage.setItem(STORE_KEY, JSON.stringify(sets)); }catch(e){}
}
function fmtS(x){
  const n = num(x);
  if(n===null) return "‚Äî";
  if(n < 10) return n.toFixed(2) + " s";
  return n.toFixed(1) + " s";
}
function fmt1(x, suf=""){
  const n = num(x);
  if(n===null) return "‚Äî";
  return n.toFixed(1) + suf;
}
function fmt0(x, suf=""){
  const n = num(x);
  if(n===null) return "‚Äî";
  return Math.round(n) + suf;
}
function qualityBadge(q){
  const n = num(q);
  if(n===null) return {t:"‚Äî", c:""};
  if(n>=85) return {t:"Ottimo", c:"ok"};
  if(n>=65) return {t:"Buono", c:"warn"};
  return {t:"Da migliorare", c:"bad"};
}

function renderLive(){
  $("liveReps").textContent = (live.reps ?? "‚Äî");
  $("liveTut").textContent  = (live.tut_s==null) ? "‚Äî" : fmtS(live.tut_s);
  $("liveEnv").textContent  = (live.cnv==null) ? "‚Äî" : fmt1(live.cnv);
  $("livePhase").textContent = "phase " + (live.phase ?? "‚Äî");
  $("liveThr").textContent = "thr " + (live.thr_hi==null ? "‚Äî" : fmt1(live.thr_hi)) + " / " + (live.thr_lo==null ? "‚Äî" : fmt1(live.thr_lo));
  $("liveEx").textContent = live.exercise || "‚Äî";
}

function renderLastSet(){
  const s = lastSet;
  if(!s){
    $("lastSetMini").textContent="‚Äî";
    $("lastExercise").textContent="‚Äî";
    $("lastReps").textContent="‚Äî";
    $("lastTut").textContent="‚Äî";
    $("lastQuality").textContent="‚Äî";
    $("lastVel").textContent="‚Äî";
    $("lastRom").textContent="‚Äî";
    $("lastRir").textContent="‚Äî";
    $("lastRaw").textContent="‚Äî";
    $("lastQ").textContent="‚Äî";
    $("lastBadge").textContent="‚Äî";
    $("lastBadge").className="pill";
    drawSpark();
    return;
  }

  $("lastSetMini").textContent = `${s.exercise || "‚Äî"} ¬∑ reps ${s.reps ?? "‚Äî"} ¬∑ Q ${fmt0(s.quality)}`;
  $("lastExercise").textContent = s.exercise || "‚Äî";
  $("lastReps").textContent = (s.reps ?? "‚Äî");
  $("lastTut").textContent = fmtS(s.tut_s);
  $("lastQuality").textContent = fmt0(s.quality);
  $("lastVel").textContent = fmt1(s.velLoss, "%");
  $("lastRom").textContent = fmt1(s.romLoss, "%");
  $("lastRir").textContent = (s.rir_est==null || s.target_rir==null)
    ? "‚Äî"
    : `${s.rir_est} / ${s.target_rir} (${s.hit_target ? "hit" : "no"})`;
  $("lastRaw").textContent = s.raw || "‚Äî";

  $("lastQ").textContent = fmt0(s.quality);
  const b = qualityBadge(s.quality);
  $("lastBadge").textContent = b.t;
  $("lastBadge").className = "pill badge " + b.c;
  drawSpark();
}

function renderHistory(){
  $("histCount").textContent = String(sets.length);
  const list = $("histList");
  list.innerHTML = "";
  $("histEmpty").classList.toggle("hidden", sets.length>0);

  const arr = [...sets].sort((a,b)=>(Number(b.id||0)-Number(a.id||0)));
  for(const s of arr){
    const div = document.createElement("div");
    div.className="item";

    const left = document.createElement("div");
    left.className="left";

    const title = document.createElement("div");
    title.className="title";
    title.textContent = `${s.exercise || "‚Äî"} ¬∑ reps ${s.reps ?? "‚Äî"} ¬∑ Q ${fmt0(s.quality)}`;

    const metaLine = document.createElement("div");
    metaLine.className="meta";
    metaLine.textContent = `id ${s.id ?? "‚Äî"} ¬∑ TUT ${fmtS(s.tut_s)} ¬∑ vL ${fmt1(s.velLoss,"%")} ¬∑ rL ${fmt1(s.romLoss,"%")}`;

    left.appendChild(title);
    left.appendChild(metaLine);

    const right = document.createElement("div");
    right.className="right";

    const b = qualityBadge(s.quality);
    const badge = document.createElement("span");
    badge.className = "badge " + b.c;
    badge.textContent = b.t;

    const btn = document.createElement("button");
    btn.className="miniBtn secondary";
    btn.textContent="Dettaglio";
    btn.onclick = ()=>openDetail(s);

    right.appendChild(badge);
    right.appendChild(btn);

    div.appendChild(left);
    div.appendChild(right);

    div.onclick = (ev)=>{
      if(ev.target === btn) return;
      openDetail(s);
    };

    list.appendChild(div);
  }
}

function drawSpark(){
  const svg = $("spark");
  const w = 140, h = 26, pad=2;
  svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  svg.innerHTML = "";

  const qs = sets.slice(-20).map(s=>num(s.quality)).filter(v=>v!==null);

  if(qs.length < 2){
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1","2"); line.setAttribute("y1", String(h/2));
    line.setAttribute("x2", String(w-2)); line.setAttribute("y2", String(h/2));
    line.setAttribute("stroke","#ddd"); line.setAttribute("stroke-width","2");
    svg.appendChild(line);
    return;
  }

  const min = Math.min(...qs, 0);
  const max = Math.max(...qs, 100);
  const span = (max-min) || 1;
  const step = (w - pad*2) / (qs.length - 1);

  let d = "";
  qs.forEach((v,i)=>{
    const x = pad + step*i;
    const y = pad + (h - pad*2) * (1 - (v - min)/span);
    d += (i===0 ? "M" : "L") + x.toFixed(1) + " " + y.toFixed(1) + " ";
  });

  const path = document.createElementNS("http://www.w3.org/2000/svg","path");
  path.setAttribute("d", d.trim());
  path.setAttribute("fill","none");
  path.setAttribute("stroke","#111");
  path.setAttribute("stroke-width","2");
  path.setAttribute("stroke-linecap","round");
  path.setAttribute("stroke-linejoin","round");
  svg.appendChild(path);
}

function openDetail(s){
  $("modal").classList.add("open");
  $("mTitle").textContent = `Set id ${s.id ?? "‚Äî"} ¬∑ ${s.exercise || "‚Äî"}`;
  const g = $("mGrid");
  g.innerHTML = "";

  const add = (k,v)=>{
    const a = document.createElement("div");
    a.textContent = k;
    const b = document.createElement("div");
    b.textContent = v;
    g.appendChild(a); g.appendChild(b);
  };

  add("Esercizio", s.exercise || "‚Äî");
  add("ID", String(s.id ?? "‚Äî"));
  add("Reps", String(s.reps ?? "‚Äî"));
  add("TUT", fmtS(s.tut_s));
  add("Quality", fmt0(s.quality));
  add("VelLoss", fmt1(s.velLoss, "%"));
  add("RomLoss", fmt1(s.romLoss, "%"));
  add("Dirty", fmt1(s.dirty, "%"));
  add("RIR est / target", (s.rir_est==null || s.target_rir==null) ? "‚Äî" : `${s.rir_est} / ${s.target_rir} (${s.hit_target ? "hit" : "no"})`);
  add("RAW file", s.raw || "‚Äî");
  add("Timestamp ms", String(s.ms ?? "‚Äî"));
  add("exIndex", String(s.exIndex ?? s.exindex ?? "‚Äî"));
}

$("btnCloseModal").onclick = ()=>$("modal").classList.remove("open");
$("modal").onclick = (e)=>{ if(e.target === $("modal")) $("modal").classList.remove("open"); };

function downloadText(filename, text, mime="application/json"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ========================= handle incoming objects ========================= */
function handleObj(obj, raw){
  if(!obj) return;
  dbgRX(raw);

  // battery (due formati)
  if(obj.bat) updateBattery(obj.bat);
  if(obj.type==="bat" && obj.bat) updateBattery(obj.bat);

  // ---------- LOG protocol ----------
  if(obj.type==="log_begin"){
    logDl = { parts:[], size:Number(obj.size)||0, got:0 };
    return;
  }
  if(obj.type==="log_chunk"){
    if(!logDl) return;
    const bytes = b64ToBytes(obj.b64);
    logDl.parts.push(bytes);
    logDl.got += bytes.length;
    return;
  }
  if(obj.type==="log_end"){
    if(!logDl) return;

    let total = 0;
    for(const p of logDl.parts) total += p.length;

    const out = new Uint8Array(total);
    let off=0;
    for(const p of logDl.parts){
      out.set(p,off);
      off+=p.length;
    }

    saveBytesAsFile(out, "sets.jsonl");
    logDl = null;
    return;
  }
  if(obj.type==="cleared"){
    alert("LOG cancellato dal device");
    return;
  }
  if(obj.type==="fs_formatted"){
    alert("Filesystem formattato (RAW + LOG)");
    rawList=[];
    $("rawSelect").innerHTML="";
    setRawBar(0);
    return;
  }

  // display status
  if(obj.type==="disp"){
    setDispUI(!!obj.on);
    return;
  }

  if(obj.type==="meta"){
    metaReceived=true;
    meta=obj;

    // abilita UI che dipende da META
    $("btnRawInfo").disabled=false;
    $("btnRawClear").disabled=false;

    $("btnLogDl").disabled=false;
    $("btnLogClear").disabled=false;
    $("btnFormat").disabled=false;

    fillExercises(obj.exercises || [], Number(obj.exIndex ?? 0));

    $("btnDisp").disabled=false;
    if(typeof obj.disp === "boolean") setDispUI(obj.disp);
    else setDispUI(true);

    return;
  }

  // ---------- WORKOUT: LIVE ----------
  if(obj.type==="live"){
    live.reps = (obj.reps ?? live.reps);
    live.tut_s = (obj.tut_s ?? live.tut_s);
    live.cnv = (obj.cnv ?? obj.env ?? live.cnv);
    live.thr_hi = (obj.thr_hi ?? live.thr_hi);
    live.thr_lo = (obj.thr_lo ?? live.thr_lo);
    live.phase = (obj.phase ?? live.phase);
    live.exercise = (obj.exercise ?? live.exercise);
    live.exindex = (obj.exindex ?? obj.exIndex ?? live.exindex);
    renderLive();
    return;
  }

  // ---------- WORKOUT: SET ----------
  if(obj.type==="set"){
    const s = {...obj};
    if(s.ms == null) s.ms = Date.now();
    if(s.exercise == null && meta && Array.isArray(meta.exercises) && s.exindex != null){
      s.exercise = meta.exercises[Number(s.exindex)] || "‚Äî";
    }

    sets.push(s);
    if(sets.length > 500) sets = sets.slice(-500);

    saveSets();
    lastSet = s;

    renderHistory();
    renderLastSet();
    return;
  }

  // ---------- RAW protocol ----------
  if(obj.type==="raw_info"){
    rawList = Array.isArray(obj.files) ? obj.files : [];
    rawList.sort((a,b)=>String(a.name).localeCompare(String(b.name)));

    const sel=$("rawSelect");
    sel.innerHTML="";

    for(const f of rawList){
      const opt=document.createElement("option");
      opt.value = f.name;
      const kb = Math.round((Number(f.size)||0)/1024);
      opt.textContent = `${normRawPath(f.name)} (${kb} KB)`;
      sel.appendChild(opt);
    }

    const has = rawList.length>0;
    sel.disabled = !has;
    $("btnRawDl").disabled = !has;
    $("btnRawDlAll").disabled = !has;

    setRawStatus(has ? `Trovati ${rawList.length} file` : "Nessun file RAW");
    $("rawHint").textContent = has
      ? "Seleziona e premi Download, oppure Download ALL."
      : "Nessun RAW: registra una serie sul device.";
    return;
  }

  if(obj.type==="raw_cleared"){
    rawList=[];
    $("rawSelect").innerHTML="";
    $("rawSelect").disabled=true;
    $("btnRawDl").disabled=true;
    $("btnRawDlAll").disabled=true;
    setRawStatus(`RAW cancellati su ESP32 (${obj.n ?? 0})`);
    setRawBar(0);
    return;
  }

  if(obj.type==="raw_err"){
    if(dl && dl.timer) clearTimeout(dl.timer);
    handleDlFail(obj.msg || "raw_err");
    return;
  }

  if(obj.type==="raw_begin"){
    const name = normRawPath(obj.name || "");
    if(!dl || (name && dl.name !== name)){
      dl = { name, size: 0, got: 0, parts: [], timer: null };
    }
    dl.size = Number(obj.size)||0;
    dl.got = 0;
    dl.parts = [];
    setRawBar(0);
    setRawStatus(dlAll && dlAll.running ? `Download ALL: ${dl.name}` : `Download: ${dl.name}`);
    dlStartTimeout(20000);
    return;
  }

  if(obj.type==="raw_chunk"){
    if(!dl){
      dl = { name: normRawPath(obj.name || "raw.csv"), size: 0, got: 0, parts: [], timer: null };
    }
    const nm = normRawPath(obj.name || dl.name);
    if(nm && dl.name && nm !== dl.name) return;

    if(typeof obj.b64 === "string"){
      const bytes = b64ToBytes(obj.b64);
      dl.parts.push(bytes);
      dl.got += bytes.length;
    }

    const pct = dl.size ? (dl.got/dl.size*100) : 0;
    setRawBar(dl.size ? pct : 0);

    if(dl.size){
      setRawStatus(`${dlAll && dlAll.running ? "Download ALL" : "Download"} ${Math.min(99,Math.round(pct))}%`);
    }else{
      setRawStatus(`Ricevuti ${dl.got}B`);
    }

    dlStartTimeout(20000);
    return;
  }

  if(obj.type==="raw_end"){
    if(!dl) return;
    if(dl.timer) clearTimeout(dl.timer);

    let total = 0;
    for(const p of dl.parts) total += p.length;

    const out = new Uint8Array(total);
    let off=0;
    for(const p of dl.parts){
      out.set(p, off);
      off += p.length;
    }

    saveBytesAsFile(out, dl.name || obj.name || "raw.csv");

    setRawBar(100);
    setRawStatus(dlAll && dlAll.running ? `Salvato ‚úÖ (${dl.name})` : "Salvato ‚úÖ");

    dl = null;

    if(dlAll && dlAll.running){
      const totalN = dlAll.queue.length;
      const doneN = dlAll.idx + 1;
      setRawBar((doneN/totalN)*100);
      setTimeout(()=>advanceAll(), 250);
    }
    return;
  }
}

/* ========================= UI actions (registrati UNA volta) ========================= */

// Connect
$("btnConnect").onclick = async ()=>{
  try{
    // reset UI ‚Äúsoft‚Äù
    metaReceived=false;
    meta=null;

    dlResetUI();
    rawList=[];
    $("rawSelect").innerHTML="";
    $("rawSelect").disabled=true;

    $("exSelect").innerHTML="";
    $("exSelect").disabled=true;
    $("btnSetEx").disabled=true;
    $("exBadge").textContent="‚Äî";
    $("btnDisp").disabled=true;
    $("dispBadge").textContent="‚Äî";
    setQuickExercise("‚Äî");

    // reset live (non cancella storico)
    live = { reps:null, tut_s:null, cnv:null, thr_hi:null, thr_lo:null, phase:null, exercise:null, exindex:null };
    renderLive();

    dev = await navigator.bluetooth.requestDevice({
      filters: [{ services: [UUID_SERVICE] }],
      optionalServices: [UUID_SERVICE]
    });

    dev.addEventListener("gattserverdisconnected", onDisconnected);

    server = await dev.gatt.connect();
    svc = await server.getPrimaryService(UUID_SERVICE);
    chTX = await svc.getCharacteristic(UUID_TX);
    chRX = await svc.getCharacteristic(UUID_RX);

    await chTX.startNotifications();
    chTX.addEventListener("characteristicvaluechanged", onNotify);

    $("btnMeta").disabled=false;
    setConn(true);

    await writeCmd({cmd:"HELLO"});
    await writeCmd({cmd:"META"});
  }catch(e){
    console.error(e);
    onDisconnected();
    alert("Connessione fallita (Web Bluetooth). Apri in Chrome/Edge e accetta il pairing.");
  }
};

// META manuale
$("btnMeta").onclick = async ()=>{
  try{ await writeCmd({cmd:"META"}); }catch(e){}
};

// RAW list
$("btnRawInfo").onclick = async ()=>{
  try{
    dlResetUI();
    setRawStatus("Richiedo lista...");
    await writeCmd({cmd:"RAW_INFO"});
  }catch(e){}
};

// RAW download one
$("btnRawDl").onclick = async ()=>{
  try{
    dlResetUI();
    const name = $("rawSelect").value;
    if(!name){ setRawStatus("Seleziona un file"); return; }
    await downloadOne(name, false);
  }catch(e){}
};

// RAW download all
$("btnRawDlAll").onclick = async ()=>{
  try{
    dlResetUI();
    await downloadAll();
  }catch(e){}
};

// RAW clear
$("btnRawClear").onclick = async ()=>{
  try{
    const x = prompt("Scrivi CLEAR per cancellare TUTTI i RAW dal device:");
    if(x !== "CLEAR") return;
    dlResetUI();
    setRawStatus("Cancellazione...");
    await writeCmd({cmd:"RAW_CLEAR"});
  }catch(e){}
};

// Exercise set
$("btnSetEx").onclick = async ()=>{
  try{
    const i = Number($("exSelect").value);
    if(!Number.isFinite(i)) return;
    await writeCmd({cmd:"SET_EX", i});
    if(meta && Array.isArray(meta.exercises)){
      $("exBadge").textContent = meta.exercises[i] || "‚Äî";
      setQuickExercise(meta.exercises[i] || "‚Äî");
    }
  }catch(e){}
};

// Exercise change UI only
$("exSelect").onchange = ()=>{
  if(meta && Array.isArray(meta.exercises)){
    const i = Number($("exSelect").value);
    $("exBadge").textContent = meta.exercises[i] || "‚Äî";
    setQuickExercise(meta.exercises[i] || "‚Äî");
  }
};

// Display toggle
$("btnDisp").onclick = async ()=>{
  try{
    await writeCmd({cmd:"DISP", on: !dispOn});
    setDispUI(!dispOn); // ottimistico
  }catch(e){}
};

// LOG download
$("btnLogDl").onclick = async ()=>{
  try{ await writeCmd({cmd:"LOG_GET"}); }catch(e){}
};

// LOG clear
$("btnLogClear").onclick = async ()=>{
  try{
    const x = prompt("Scrivi CLEAR per cancellare il LOG dal device:");
    if(x !== "CLEAR") return;
    await writeCmd({cmd:"LOG_CLEAR"});
  }catch(e){}
};

// FORMAT FS
$("btnFormat").onclick = async ()=>{
  try{
    const x = prompt("Scrivi FORMAT per cancellare TUTTO il filesystem:");
    if(x !== "FORMAT") return;
    await writeCmd({cmd:"FS_FORMAT"});
  }catch(e){}
};

// Export JSON/CSV + clear history (browser)
$("btnExportJson").onclick = ()=>{
  const data = JSON.stringify(sets, null, 2);
  downloadText("salusmotion_sets.json", data, "application/json");
};
$("btnExportCsv").onclick = ()=>{
  const cols = ["id","ms","exercise","exIndex","reps","tut_s","quality","velLoss","romLoss","dirty","rir_est","target_rir","hit_target","raw"];
  const esc = (v)=>{
    const s = String(v ?? "");
    if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
    return s;
  };
  const lines = [cols.join(",")];
  for(const s of sets){
    lines.push(cols.map(c=>esc(s[c])).join(","));
  }
  downloadText("salusmotion_sets.csv", lines.join("\n"), "text/csv");
};
$("btnClearHistory").onclick = ()=>{
  const x = prompt("Scrivi CLEAR per cancellare lo storico della webapp:");
  if(x !== "CLEAR") return;
  sets = [];
  lastSet = null;
  saveSets();
  renderHistory();
  renderLastSet();
  renderLive();
};

/* ========================= init ========================= */
setConn(false);
renderHistory();
renderLastSet();
renderLive();
</script>
</body>
</html>
